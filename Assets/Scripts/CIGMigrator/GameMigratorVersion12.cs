using System;
using System.Collections.Generic;

namespace CIGMigrator
{
	public class GameMigratorVersion12 : IMigrator
	{
		private const decimal ProgressAmount = 0.9m;

		private const string GameStateKey = "GameState";

		private const string LevelKey = "Level";

		private const string EarnedBalanceKey = "EarnedBalance";

		private const string XPCurrency = "XP";

		private static readonly int[] OldXpPerLevel = new int[150]
		{
			0,
			250,
			500,
			1000,
			1500,
			2000,
			2500,
			3000,
			4000,
			5000,
			8800,
			24000,
			29000,
			34000,
			39000,
			49000,
			62000,
			86000,
			110000,
			130000,
			170000,
			210000,
			260000,
			340000,
			420000,
			510000,
			620000,
			750000,
			900000,
			1100000,
			1200000,
			1400000,
			1700000,
			2000000,
			2300000,
			2600000,
			3000000,
			3400000,
			3800000,
			4400000,
			4900000,
			5500000,
			6100000,
			6800000,
			7500000,
			8200000,
			9100000,
			9900000,
			11000000,
			12000000,
			13000000,
			14000000,
			16000000,
			17000000,
			19000000,
			20000000,
			22000000,
			24000000,
			26000000,
			28000000,
			30000000,
			32000000,
			35000000,
			37000000,
			40000000,
			42000000,
			45000000,
			48000000,
			51000000,
			54000000,
			57000000,
			61000000,
			64000000,
			68000000,
			72000000,
			76000000,
			81000000,
			85000000,
			90000000,
			95000000,
			100000000,
			110000000,
			110000000,
			120000000,
			130000000,
			130000000,
			140000000,
			150000000,
			160000000,
			160000000,
			170000000,
			180000000,
			190000000,
			200000000,
			210000000,
			220000000,
			230000000,
			240000000,
			260000000,
			270000000,
			280000000,
			290000000,
			310000000,
			320000000,
			330000000,
			350000000,
			360000000,
			380000000,
			390000000,
			410000000,
			420000000,
			440000000,
			460000000,
			480000000,
			490000000,
			510000000,
			530000000,
			540000000,
			560000000,
			580000000,
			600000000,
			610000000,
			630000000,
			650000000,
			670000000,
			680000000,
			700000000,
			720000000,
			740000000,
			750000000,
			770000000,
			790000000,
			800000000,
			820000000,
			840000000,
			860000000,
			870000000,
			890000000,
			910000000,
			930000000,
			940000000,
			960000000,
			980000000,
			1000000000,
			1000000000,
			1000000000,
			1000000000,
			1100000000,
			1100000000,
			1100000000
		};

		private static readonly int[] NewXpPerLevel = new int[150]
		{
			0,
			250,
			500,
			1000,
			1500,
			2000,
			2500,
			3000,
			4000,
			5000,
			8790,
			12100,
			16900,
			21600,
			26700,
			36500,
			48900,
			72700,
			93500,
			121000,
			152000,
			193000,
			243000,
			318000,
			399000,
			488000,
			601000,
			730000,
			871000,
			1040000,
			1220000,
			1410000,
			1660000,
			1930000,
			2230000,
			2560000,
			2930000,
			3330000,
			3790000,
			4300000,
			4850000,
			5420000,
			6040000,
			6700000,
			7400000,
			8160000,
			8960000,
			9830000,
			10800000,
			11900000,
			13000000,
			14300000,
			15600000,
			17000000,
			18500000,
			20200000,
			21900000,
			23700000,
			25600000,
			27600000,
			29700000,
			32000000,
			34300000,
			36800000,
			39300000,
			42000000,
			44800000,
			47700000,
			50700000,
			53800000,
			57100000,
			60400000,
			63900000,
			67600000,
			71600000,
			75800000,
			80200000,
			84700000,
			89600000,
			94800000,
			101000000,
			107000000,
			113000000,
			119000000,
			126000000,
			133000000,
			140000000,
			147000000,
			155000000,
			164000000,
			173000000,
			182000000,
			191000000,
			201000000,
			211000000,
			222000000,
			233000000,
			244000000,
			256000000,
			268000000,
			280000000,
			293000000,
			306000000,
			320000000,
			334000000,
			348000000,
			362000000,
			377000000,
			393000000,
			408000000,
			425000000,
			441000000,
			458000000,
			476000000,
			493000000,
			510000000,
			528000000,
			545000000,
			562000000,
			580000000,
			597000000,
			614000000,
			632000000,
			649000000,
			667000000,
			684000000,
			701000000,
			719000000,
			736000000,
			753000000,
			771000000,
			788000000,
			805000000,
			823000000,
			840000000,
			858000000,
			875000000,
			892000000,
			910000000,
			927000000,
			944000000,
			962000000,
			979000000,
			996000000,
			1020000000,
			1040000000,
			1050000000,
			1070000000,
			1090000000,
			1110000000
		};

		public void Migrate(Dictionary<string, object> storageRoot)
		{
			object value2;
			Dictionary<string, object> dictionary;
			object obj;
			if (!storageRoot.TryGetValue("GameState", out object value) || (dictionary = (value as Dictionary<string, object>)) == null || !dictionary.TryGetValue("Level", out value2) || !((obj = value2) is int))
			{
				return;
			}
			int num = (int)obj;
			object value4;
			Dictionary<string, object> dictionary2;
			if (!dictionary.TryGetValue("EarnedBalance", out object value3) || (dictionary2 = (value3 as Dictionary<string, object>)) == null || !dictionary2.TryGetValue("XP", out value4) || !((obj = value4) is decimal))
			{
				return;
			}
			decimal d = (decimal)obj;
			int num2 = num - 1;
			if (num2 >= 0 && num2 < OldXpPerLevel.Length - 1)
			{
				int num3 = OldXpPerLevel[num2];
				int num4 = OldXpPerLevel[num2 + 1];
				if (d < (decimal)num3)
				{
					d = (decimal)num3 + (decimal)(num4 - num3) * 0.9m;
				}
				decimal d2 = (d - (decimal)num3) / (decimal)(num4 - num3);
				int num5 = NewXpPerLevel[num2];
				int num6 = NewXpPerLevel[num2 + 1];
				decimal d3 = (decimal)num5 + (decimal)(num6 - num5) * d2;
				dictionary2["XP"] = Math.Round(d3);
			}
			else if (num2 == OldXpPerLevel.Length - 1)
			{
				dictionary2["XP"] = (decimal)NewXpPerLevel[NewXpPerLevel.Length - 1];
			}
		}
	}
}
